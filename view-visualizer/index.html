<!DOCTYPE html>
<!--

   Copyright 2015 John Francis Mukulu <john.f.mukulu@gmail.com>

   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software
   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
   MA 02110-1301, USA.


-->
<html ng-app="viewVisualizer">
    <head>
        <title>View Visualizer</title>

        <meta name="description" content="DHIS 2">
        <meta name="keywords" content="DHIS 2">        
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.min.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/ui/jquery-ui.min.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.plugin.min.js"></script>

        <script type="text/javascript" src="../../../dhis-web-commons/bootstrap/js/bootstrap.min.js"></script>     
        <link type="text/css" rel="stylesheet"  href="../../../dhis-web-commons/bootstrap/css/bootstrap.min.css">      

        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/angular/angular.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/angular/angular-resource.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/angular/angular-route.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/angular/angular-cookies.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/angular/angular-animate.js"></script>  
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/angular/ui-bootstrap-tpls-0.10.0-draggable-modal.js"></script>

        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/moment/moment-with-langs.min.js"></script>       

        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/underscore.min.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.util.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/commons.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/commons.ajax.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/lists.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/periodType.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/date.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/json2.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/validationRules.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.array.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.select.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.comparator.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.availability.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.trigger.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.sharing.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.validation.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.storage.ss.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.storage.ls.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.storage.idb.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.storage.memory.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.storage.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.contextmenu.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.appcache.js"></script>

        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/angular/plugins/angularLocalStorage.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/angular/plugins/angular-translate.min.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/angular/plugins/dhis2/services.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/angular/plugins/dhis2/controllers.js"></script>

        <script type="text/javascript" src="scripts/app.js"></script>        
        <script type="text/javascript" src="scripts/services.js"></script>
        <script type="text/javascript" src="scripts/directives.js"></script>
        <script type="text/javascript" src="scripts/controllers.js"></script>
        <script type="text/javascript" src="scripts/filters.js"></script>

        <!-- Menu scripts -->
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.translate.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.menu.js"></script>
        <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.menu.ui.js"></script>

        <link type="text/css" rel="stylesheet" href="../../../dhis-web-commons/font-awesome/css/font-awesome.min.css"/>
        <link type="text/css" rel="stylesheet" media="screen" href="../../../dhis-web-commons/css/widgets.css"/>
        <link type="text/css" rel="stylesheet" media="screen" href="../../../dhis-web-commons/css/menu.css">

        <link type="text/css" rel="stylesheet" href="styles/style.css">
        <link type="text/css" rel="stylesheet" href="styles/bootstrap.css">
        <link type="text/css" rel="stylesheet" href="styles/bootstrap-theme.css">
        <link type="text/css" rel="stylesheet" href="styles/sb-admin-2.css">
        
        
		<!-- external libs from cdnjs -->

        <link rel="stylesheet" type="text/css" href="styles/c3.min.css">
        <link rel="stylesheet" type="text/css" href="styles/chosen.min.css">
        <script type="text/javascript" src="scripts/d3.min.js"></script>
        <script type="text/javascript" src="scripts/jquery.ui.touch-punch.min.js"></script>
        <script type="text/javascript" src="scripts/jquery.csv-0.71.min.js"></script>
        <script type="text/javascript" src="scripts/chosen.jquery.js"></script>
        <script type="text/javascript" src="scripts/c3.min.js"></script>
        
        <!-- PivotTable.js libs from ../dist -->
        <link rel="stylesheet" type="text/css" href="styles/pivot.css">
        <script type="text/javascript" src="scripts/pivot.js"></script>
        <script type="text/javascript" src="scripts/d3_renderers.js"></script>
        <script type="text/javascript" src="scripts/c3_renderers.js"></script>
        <script type="text/javascript" src="scripts/export_renderers.js"></script>

    </head>

    <body>
        <d2-header-bar></d2-header-bar>

        <div id="leftBar"></div>
        <div class="page" id="mainPage" ng-controller="MainController">
			
			<div style="padding-top:5px;"></div>

            <!-- top bar begins -->
            <div class="row top-bar">        
                <div class="col-sm-12">            
                    {{'view_visualizer_header'| translate}}
                </div>        
            </div>
            <!-- top bar ends -->


            <div class="row col-lg-13">
				<div class="panel-body">				
					<p>Select Views for Analysis :
					<select id="csv"  data-placeholder="Choose view from the list"><option></option></select> &nbsp; &nbsp; <span id="doc"></span></p>
					<div id="output" style="margin: 10px;">
						<div class="row">
							<div class="col-lg-4 col-md-6">
								<div class="panel panel-primary">
									<div class="panel-heading">
										<div class="row">
											<div class="col-xs-3"><i class="fa fa-table fa-5x"></i></div>
											<div class="col-xs-9 text-right"><div class="huge">PivotTable</div></div>
										</div>
									</div>
									<a href="">
										<div class="panel-footer">
											<span class="pull-left">Experience the full potiential of pivot tables on SQL views like never before</span>
											<span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
											<div class="clearfix"></div>
										</div>
									</a>
								</div>
							</div>
							<div class="col-lg-4 col-md-6">
								<div class="panel panel-green">
									<div class="panel-heading">
										<div class="row">
											<div class="col-xs-3"><i class="fa fa-bar-chart-o fa-5x"></i></div>
											<div class="col-xs-9 text-right"><div class="huge">Charts</div></div>
										</div>
									</div>
									<a href="">
										<div class="panel-footer">
											<span class="pull-left">Unleash chart visualization right out of your sqlviews</span>
											<span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
											<div class="clearfix"></div>
										</div>
									</a>
								</div>
							</div>
							<div class="col-lg-4 col-md-6">
								<div class="panel panel-yellow">
									<div class="panel-heading">
										<div class="row">
											<div class="col-xs-3"><i class="fa fa-filter fa-5x"></i></div>
											<div class="col-xs-9 text-right"><div class="huge">Filter&amp;Group</div></div>
										</div>
									</div>
									<a href="">
										<div class="panel-footer">
											<span class="pull-left">Filter through pile of data from sql view with ability to group and arrange data by criterias</span>
											<span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
											<div class="clearfix"></div>
										</div>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>	
            </div>
            <div class="row col-lg-13">
				View visualizer can be used to make analysis of of:
				<ul>
					<li>Organisation units distributions in relation to groups and groupsets
						<em>
						
						SELECT d.name AS "Region Name",
						d.uid AS "Region UID",
						c.name AS "District Name",
						c.uid AS "District UID",
						b.name AS "Facility Name",
						b.shortname AS "Facility shortname",
						b.uid AS "Facility UID",
						b.created AS "Date created",
						b.lastupdated AS "Last updated",
						g."Ownership",
						g."Ownerships with general groups" AS "Ownership with General Groups",
						g."Type",
						b.coordinates
					   FROM _orgunitstructure orgstructure
						 LEFT JOIN organisationunit orgunit ON orgstructure.organisationunitid = orgunit.organisationunitid
						 LEFT JOIN organisationunit c ON orgstructure.idlevel3 = c.organisationunitid
						 JOIN _organisationunitgroupsetstructure g ON g.organisationunitid = b.organisationunitid
						 LEFT JOIN organisationunit d ON orgstructure.idlevel2 = d.organisationunitid
					  WHERE a.level = 4 AND (orgstructure.organisationunitid IN ( SELECT DISTINCT datasetsource.sourceid
							   FROM datasetsource))
					  ORDER BY d.name, c.name, b.name;
						</em>
					</li>
				</ul>
			</div>
            
            
        </div>
        <style type="text/css">
            body {font-family: Verdana;}
            .node {
                border: solid 1px white;
                font: 10px sans-serif;
                line-height: 12px;
                overflow: hidden;
                position: absolute;
                text-indent: 2px;
            }
            .c3-line, .c3-focused {stroke-width: 3px !important;}
            .c3-bar {stroke: white !important; stroke-width: 1;}
            .c3 text { font-size: 12px; color: grey;}
            .tick line {stroke: white;}
            .c3-axis path {stroke: grey;}
        </style>
		<script type="text/javascript">
			window.dhis2 = window.dhis2 || {};
			dhis2.settings = dhis2.settings || {};
			dhis2.settings.baseUrl = '';
			
			$(function(){
                $.get("../../../api/sqlViews.json?paging=false&fields=href,name", function(sqlViewList){
                    var pkg = $("<optgroup>", {label: ""});
                    var csvlist_arr =sqlViewList.sqlViews;
                    for(var i in csvlist_arr)
                    {
                        var dataset = csvlist_arr[i];
                        if(dataset.name != pkg.attr("label"))
                        {
                            pkg = $("<optgroup>", {label: dataset.name}).appendTo($("#csv"));
                        }
                        pkg.append($("<option>", {value: dataset.href}).text(dataset.name));
                    }
                    $("#csv").chosen();
                    $("#csv").bind("change", function(event){
                        $("#output").empty().text("Loading...")
                        var val = $(this).val();
                        $.get(val+'/data.csv', function(csvtext){

                            var input = $.csv.toArrays(csvtext);
                            input[0][0] = "Row";
                            var renderers = $.extend(
                                    $.pivotUtilities.renderers,
                                    $.pivotUtilities.c3_renderers,
                                    $.pivotUtilities.d3_renderers,
                                    $.pivotUtilities.export_renderers
                            );

                            $("#output").pivotUI(input, {renderers: renderers}, true);
                        });
                    });
                });
            });
		</script>

    </body>
</html>
